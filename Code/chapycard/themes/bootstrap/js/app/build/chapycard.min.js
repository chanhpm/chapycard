/*
  chapycard 0.0.1 2014-05-03
  Copyright (c) 2014 

  Released under  License
*/
!function(a,b){"use strict";b.Builder=function(c,d,e){1!==c.length&&a.error("the application requires only one iframe");var f=this;f.contents=c.contents(),f.tabs={},f.stylesheet=new b.Stylesheet,f.style=a("<style>"),f.controls=e,f.app={},f.build(d)},b.Builder.prototype={constructor:b.Builder,build:function(a){var b=this;b.loadDom(a),b.loadApp(a),b.style.appendTo(b.contents.find("head"))},loadApp:function(b){var c=this;a.each(b.app,function(a,b){c.app[a]=b.selector})},loadDom:function(c){var d=this;a.each(c.tab,function(c,e){d.tabs[e.name]=new b.Tab(c,d);d.tabs[e.name];a.each(e.controls,function(c,f){var g=new b.Control(d.tabs[e.name],d);a.extend(g,b.Controls.get(c)),g.selector=f.selector,g.init(),d.tabs[e.name].addControl(g)}),d.tabs[e.name].build(),e.init&&d.tabs[e.name].active(),d.controls.append(d.tabs[e.name].element)})},getActiveTab:function(){var b=this,c=null;return a.each(b.tabs,function(a,b){b.status===!0&&(c=b)}),c},activeTab:function(a){this.tabs[a].active()},deactiveTab:function(a){this.tabs[a].deactive()},syncStyle:function(){var a=this;a.stylesheet.writeTo(a.style)},getSelector:function(){var a=this,b=a.contents.find(".active").first();return a.app[b.attr("name")]}},b.Control=function(a,b){var c=this;c.selector="",c.element="",c.fields={},c.card=b,c.tab=a,c.distinct=!1},b.Control.prototype={constructor:b.Control,build:function(){var a=this;a.element&&a.element.appendTo(a.tab.controls)},init:function(){console.log("init")},check:function(){var b=this;return b.selector||a.error("Check control: missing selector"),!0},cacheOldValue:function(){var b=this;a.each(b.fields,function(a,b){b.data("oldvalue",b.val())})},updateCss:function(a,b,c){var d=this;d.card.stylesheet.addRule(d.getSelector(c),a,b),d.card.syncStyle()},getCss:function(){},getSelector:function(a){var b=this;return b.distinct?a?"."+a+b.selector:b.card.getSelector()?b.card.getSelector()+b.selector:b.selector:b.selector}},b.Controls={controls:{},add:function(c,d){a.isPlainObject(d)||a.error("ChapyCardControls.add: control must be an object"),this.controls[c]=a.extend({},new b.Control({}),d)},get:function(a){var b=this;return b.controls[a]}},b.Stylesheet=function(){this.rules={}},b.Stylesheet.prototype={constructor:b.Stylesheet,addRule:function(a,b,c){var d=this;d.rules.hasOwnProperty(a)||(d.rules[a]={}),d.rules[a][b]=c},getRules:function(){return this.rules},mergeRules:function(b){this.rules=a.extend(!0,{},this.rules,b)},removeRule:function(b,c){var d=this;d.rules.hasOwnProperty(b)&&delete d.rules[b][c],a.isEmptyObject(d.rules[b])&&delete d.rules[b]},clearRule:function(){this.rules={}},getValueOfRule:function(a,b){var c=this;return c.rules.hasOwnProperty(a)&&c.rules[a].hasOwnProperty(b)?c.rules[a][b]:!1},toString:function(){var b="",c=this;return a.each(c.rules,function(c,d){b+=c+"{\n",a.each(d,function(a,c){b+="	"+a+":"+c+";\n"}),b+="}\n"}),a.trim(b)},writeTo:function(a){var b=this;a.html(b.toString())}},b.Tab=function(b,c){var d=this;d.name=b,d.card=c,d.status=!1,d.element=a("<div/>",{id:d.name+"_tab","class":"chapy-tab"}),a("<span />",{text:d.name}).appendTo(d.element),d.controls=a("<div/>",{"class":"chapy-control-group"})},b.Tab.prototype={constructor:b.Tab,build:function(){var b=this;b.element&&b.controls&&b.element.append(b.controls),b.element.bind("click",a.proxy(b.tabClick,b)),b.controls.bind("click",b.controlsClick)},tabClick:function(){var a=this;a.card.getActiveTab()&&a.card.getActiveTab().name===a.name?console.log("click myself"):(a.card.getActiveTab().deactive(),a.active())},controlsClick:function(a){a.stopPropagation()},active:function(){var a=this;a.status=!0,a.controls.addClass("active"),a.element.addClass("active")},deactive:function(){var a=this;a.status=!1,a.controls.removeClass("active"),a.element.removeClass("active")},addControl:function(c){var d=this;c.constructor!==b.Control&&a.error("control adding need to be an ChapyCard.Control"),d.controls.append(c.element)},removeControl:function(c){var d=this;c.constructor!==b.Control&&a.error("control removing need to be an ChapyCard.Control"),d.controls.find(c.element).remove()}},b.Util={getJSONData:function(a,b){return JSONData.hasOwnProperty(a)&&JSONData[a].hasOwnProperty(b)?JSONData[a][b]:null},updateJSONData:function(a,b,c,d){JSONData.hasOwnProperty(a)||(JSONData[a]={}),JSONData[a][b]=c,d||(JSONData[a].tab=d)}},b.Controls.add("background",{init:function(){var b=this;b.distinct=!0,b.element=a("<div class='background-controls card-control'><label for='background'>Background: </label> <input id='background' /> <input name='files' id='files' type='file' /></div>"),b.fields={bgColor:b.element.find("#background"),bgImage:b.element.find("#files")},b.fields.bgColor.kendoColorPicker({value:"#ffffff",buttons:!1,select:a.proxy(b.bgColorChange,this)}),b.fields.bgImage.kendoUpload(),b.kendoFields={bgColor:b.fields.bgColor.data("kendoColorPicker")},b.kendoFields.bgColor.wrapper.addClass("color"),b.refresh()},refresh:function(){var a=this,c=b.Util.getJSONData("background","backgroundColor");if(c){a.kendoFields.bgColor.value(c),a.bgColorChange();var d=b.Util.getJSONData("background","frontside"),e=b.Util.getJSONData("background","backside");d&&a.bgColorChangeWithValue(d.backgroundColor,"frontside"),e&&a.bgColorChangeWithValue(e.backgroundColor,"backside")}},bgColorChange:function(){this.updateCss("background-color",this.fields.bgColor.val())},bgColorChangeWithValue:function(a,b){this.updateCss("background-color",a,b)}}),b.Controls.add("border",{init:function(){var b=this;b.distinct=!0,b.element=a("<div id='border-controls' class='card-control'><label for='slider'>Border: </label> <input id='picker' /> <input id='border' /> <input id='style' /></div>"),b.fields={borderColor:b.element.find("#picker"),border:b.element.find("#border"),borderStyle:b.element.find("#style")},b.fields.borderColor.kendoColorPicker({value:"#ffffff",buttons:!1,select:a.proxy(b.borderColorChange,this)}),b.fields.border.kendoNumericTextBox({value:0,min:0,max:100,step:1,format:"n",decimals:0,spin:a.proxy(b.borderChange,this),change:a.proxy(b.borderChange,this)});var c=[{text:"Solid",value:"solid"},{text:"Dotted",value:"dotted"},{text:"Dashed",value:"dashed"},{text:"None",value:"none"}];b.fields.borderStyle.kendoDropDownList({dataTextField:"text",dataValueField:"value",dataSource:c,index:0,change:a.proxy(b.borderStyleChange,this)}),b.kendoFields={borderColor:b.fields.borderColor.data("kendoColorPicker"),border:b.fields.border.data("kendoNumericTextBox"),borderStyle:b.fields.borderStyle.data("kendoDropDownList")},b.kendoFields.border.wrapper.addClass("border"),b.kendoFields.borderStyle.wrapper.addClass("border-style"),b.refresh()},refresh:function(){var a=this,c=b.Util.getJSONData("borderColor","borderColor"),d=b.Util.getJSONData("borderWidth","borderWidth"),e=b.Util.getJSONData("borderStyle","borderStyle");if(c&&(a.kendoFields.borderColor.value(c),a.borderColorChange()),d){a.kendoFields.border.value(d),a.borderChange();var f=b.Util.getJSONData("borderWidth","frontside"),g=b.Util.getJSONData("borderWidth","backside");f&&a.borderChangeWithValue(f.borderWidth,"frontside"),g&&a.borderChangeWithValue(g.borderWidth,"backside")}if(e){a.kendoFields.borderStyle.value(e),a.borderChange();var f=b.Util.getJSONData("borderStyle","frontside"),g=b.Util.getJSONData("borderStyle","backside");f&&a.borderStyleChangeWithValue(f.borderStyle,"frontside"),g&&a.borderStyleChangeWithValue(g.borderStyle,"backside")}},borderColorChange:function(){this.updateCss("border-color",this.fields.borderColor.val())},borderChange:function(){this.updateCss("border-width",this.fields.border.val()+"px")},borderChangeWithValue:function(a,b){this.updateCss("border-width",a+"px",b)},borderStyleChange:function(){this.updateCss("border-style",this.fields.borderStyle.val())},borderStyleChangeWithValue:function(a,b){this.updateCss("border-style",a,b)}}),b.Controls.add("corner",{init:function(){var b=this;b.element=a("<div id='corner-controls' class='card-control'><label for='slider'>Corner: </label> <input id='slider' /></div>"),b.fields={corner:b.element.find("#slider")},b.fields.corner.kendoNumericTextBox({value:0,min:0,max:100,step:1,format:"n",decimals:0,spin:a.proxy(b.cornerChange,this),change:a.proxy(b.cornerChange,this)}),b.kendoFields={corner:b.fields.corner.data("kendoNumericTextBox")},b.refresh()},refresh:function(){var a=this,c=b.Util.getJSONData("corner","corner");c&&(a.kendoFields.corner.value(c),a.cornerChange())},cornerChange:function(){this.updateCss("border-radius",this.fields.corner.val()+"px")}}),b.Controls.add("height",{init:function(){var b=this;b.element=a("<div id='height' class='card-control'><label for='slider'>Height: </label> <input id='slider' /></div>"),b.fields={height:b.element.find("#slider")},b.fields.height.kendoNumericTextBox({value:216,min:100,max:700,step:1,format:"n",decimals:0,spin:a.proxy(b.changeSize,this),change:a.proxy(b.changeSize,this)}),b.kendoFields={height:b.fields.height.data("kendoNumericTextBox")},b.refresh()},refresh:function(){var a=this,c=b.Util.getJSONData("height","height");c&&(a.kendoFields.height.value(c),a.changeSize())},changeSize:function(){this.updateCss("height",this.fields.height.val()+"px")}}),b.Controls.add("width",{init:function(){var b=this;b.element=a("<div id='width' class='card-control'><label for='slider'>Width: </label> <input id='slider' /></div>"),b.fields={width:b.element.find("#slider")},b.fields.width.kendoNumericTextBox({value:333,min:100,max:700,step:1,format:"n",decimals:0,spin:a.proxy(b.changeSize,this),change:a.proxy(b.changeSize,this)}),b.kendoFields={width:b.fields.width.data("kendoNumericTextBox")},b.refresh()},refresh:function(){var a=this,c=b.Util.getJSONData("width","width");c&&(a.kendoFields.width.value(c),a.changeSize())},changeSize:function(){this.updateCss("width",this.fields.width.val()+"px")}})}(jQuery,window.ChapyCard=window.ChapyCard||{});